<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - FinalFare</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 font-['Poppins'] text-gray-800">
  <!-- Enhanced Toast Notification -->
  <div id="toast" class="hidden fixed top-6 right-6 px-8 py-4 z-50 bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-2xl shadow-2xl backdrop-blur-lg border border-white/20"></div>
  
  <!-- Enhanced Header -->
  <header class="w-full flex items-center justify-between px-8 py-6 sticky top-0 z-30 bg-white/95 backdrop-blur-xl shadow-2xl border-b border-blue-200/50 mx-4 mt-4 rounded-2xl">
    <div class="flex items-center gap-6">
      <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-green-600 rounded-2xl flex items-center justify-center shadow-2xl">
        <i class="ph-shield-check text-3xl text-white"></i>
      </div>
      <div>
        <h1 class="text-4xl font-black bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent">FinalFare Admin</h1>
        <p class="text-lg text-gray-600 font-medium">Professional Dashboard</p>
      </div>
    </div>
    <div class="flex items-center gap-6">
      <div class="text-right">
        <span id="adminUser" class="text-gray-700 font-bold text-xl"></span>
        <p class="text-sm text-gray-500">Administrator</p>
      </div>
      <button id="logoutBtn" class="bg-gradient-to-r from-blue-600 to-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-2xl hover:scale-105 transition-all duration-300 flex items-center gap-3">
        <i class="ph-sign-out text-xl"></i>
        Logout
      </button>
    </div>
  </header>

  <main class="flex flex-col lg:flex-row min-h-screen gap-6 p-4">
    <!-- Enhanced Sidebar -->
    <nav id="adminSidebar" class="hidden lg:flex flex-col w-80 min-h-screen bg-white/95 backdrop-blur-xl rounded-2xl p-6 shadow-2xl border border-blue-200/50">
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Navigation</h2>
        <div class="w-20 h-1 bg-gradient-to-r from-blue-600 to-green-600 rounded-full"></div>
      </div>
      
      <div class="space-y-3">
        <a id="navServices" class="nav-item px-6 py-4 flex items-center gap-4 cursor-pointer bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-xl shadow-lg">
          <i class="ph-briefcase text-2xl"></i>
          <span class="font-semibold">Service Management</span>
        </a>
        <a id="navSupport" class="nav-item px-6 py-4 flex items-center gap-4 cursor-pointer bg-white/80 hover:bg-gradient-to-r hover:from-blue-600 hover:to-green-600 hover:text-white rounded-xl transition-all duration-300 shadow-md">
          <i class="ph-headset text-2xl"></i>
          <span class="font-semibold">Customer Support</span>
        </a>
        <a id="navSchedule" class="nav-item px-6 py-4 flex items-center gap-4 cursor-pointer bg-white/80 hover:bg-gradient-to-r hover:from-blue-600 hover:to-green-600 hover:text-white rounded-xl transition-all duration-300 shadow-md">
          <i class="ph-calendar text-2xl"></i>
          <span class="font-semibold">Scheduling</span>
        </a>
        <a id="navCustom" class="nav-item px-6 py-4 flex items-center gap-4 cursor-pointer bg-white/80 hover:bg-gradient-to-r hover:from-blue-600 hover:to-green-600 hover:text-white rounded-xl transition-all duration-300 shadow-md">
          <i class="ph-sliders-horizontal text-2xl"></i>
          <span class="font-semibold">Custom Options</span>
        </a>
      </div>
      
      <!-- Quick Stats -->
      <div class="mt-auto pt-8">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Quick Stats</h3>
        <div class="space-y-3">
          <div class="bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Total Services</p>
                <p class="text-2xl font-bold" id="totalServices">0</p>
              </div>
              <i class="ph-briefcase text-3xl opacity-80"></i>
            </div>
          </div>
          <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm opacity-90">Pending Inquiries</p>
                <p class="text-2xl font-bold" id="pendingInquiries">0</p>
              </div>
              <i class="ph-chat-circle text-3xl opacity-80"></i>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hide sidebar when on login page -->
    <script>
      function updateSidebarVisibility() {
        const sidebar = document.getElementById('adminSidebar');
        const authSection = document.getElementById('authSection');
        if (!sidebar || !authSection) return;
        if (!authSection.classList.contains('hidden')) {
          sidebar.style.display = 'none';
        } else {
          sidebar.style.display = '';
        }
      }
      document.addEventListener('DOMContentLoaded', updateSidebarVisibility);
      const observer = new MutationObserver(updateSidebarVisibility);
      observer.observe(document.getElementById('authSection'), { attributes: true, attributeFilter: ['class'] });
    </script>

    <div class="flex-1 space-y-6">
      <!-- Enhanced Login Section -->
      <div id="authSection" class="max-w-lg mx-auto mt-20 bg-white/95 backdrop-blur-xl p-12 rounded-2xl shadow-2xl border border-blue-200/50">
        <div class="text-center mb-10">
          <div class="mx-auto w-24 h-24 bg-gradient-to-br from-blue-600 to-green-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl">
            <i class="ph-shield-check text-4xl text-white"></i>
          </div>
          <h2 class="text-4xl font-black bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent">Admin Login</h2>
          <p class="text-xl text-gray-600 mt-3 font-medium">Access your dashboard</p>
        </div>
        
        <form id="adminLoginForm" class="space-y-8">
          <div class="space-y-2">
            <label for="loginUsername" class="block text-lg font-bold text-gray-700">Username</label>
            <input type="text" id="loginUsername" name="username" required 
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300 bg-white/80">
          </div>
          <div class="space-y-2">
            <label for="loginPassword" class="block text-lg font-bold text-gray-700">Password</label>
            <input type="password" id="loginPassword" name="password" required 
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300 bg-white/80">
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-green-600 text-white py-4 rounded-xl font-semibold hover:shadow-2xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3 text-lg">
            <i class="ph-sign-in text-xl"></i>
            Login
          </button>
        </form>
      </div>

      <!-- Enhanced Dashboard -->
      <div id="adminDashboard" class="hidden space-y-8">
        <!-- Service Management -->
        <section id="serviceSection" class="bg-white/95 backdrop-blur-xl rounded-2xl p-8 shadow-2xl border border-blue-200/50 hover:shadow-3xl transition-all duration-300">
          <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-green-600 rounded-2xl flex items-center justify-center shadow-xl">
              <i class="ph-briefcase text-3xl text-white"></i>
            </div>
            <div>
              <h2 class="text-3xl font-black bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent">Manage Services & Coffins</h2>
              <p class="text-xl text-gray-600 font-medium">Add, edit, and manage your service offerings</p>
            </div>
          </div>
          
          <form id="addServiceForm" class="bg-white/80 rounded-2xl p-8 mb-8 shadow-lg border border-blue-100">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 items-end">
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Name</label>
                <input type="text" id="serviceName" placeholder="Service name" required 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
              </div>
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Price</label>
                <input type="number" id="servicePrice" placeholder="â‚±0.00" required 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
              </div>
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Type</label>
                <select id="serviceType" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
                  <option value="coffin">Coffin</option>
                  <option value="service">Service</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Description</label>
                <input type="text" id="serviceDesc" placeholder="Description" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
              </div>
              <button type="submit" class="bg-gradient-to-r from-blue-600 to-green-600 text-white py-3 rounded-xl font-semibold hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                <i class="ph-plus text-xl"></i>
                Add
              </button>
            </div>
          </form>
          
          <div class="bg-white/80 rounded-2xl overflow-hidden shadow-xl">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gradient-to-r from-blue-600 to-green-600 text-white">
                  <th class="px-6 py-4 text-left font-semibold">Name</th>
                  <th class="px-6 py-4 text-left font-semibold">Type</th>
                  <th class="px-6 py-4 text-left font-semibold">Price</th>
                  <th class="px-6 py-4 text-left font-semibold">Description</th>
                  <th class="px-6 py-4 text-left font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="serviceTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </section>

        <!-- Customer Support -->
        <section id="supportSection" class="bg-white/95 backdrop-blur-xl rounded-2xl p-8 shadow-2xl border border-blue-200/50 hover:shadow-3xl transition-all duration-300 hidden">
          <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-green-600 to-blue-600 rounded-2xl flex items-center justify-center shadow-xl">
              <i class="ph-headset text-3xl text-white"></i>
            </div>
            <div>
              <h2 class="text-3xl font-black bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">Customer Inquiries & Support</h2>
              <p class="text-xl text-gray-600 font-medium">Manage customer communications and inquiries</p>
            </div>
          </div>
          
          <div class="space-y-8">
            <div class="bg-white/80 rounded-2xl overflow-hidden shadow-xl">
              <h3 class="text-xl font-bold text-gray-700 p-6 border-b border-gray-200">Contact Submissions</h3>
              <table class="min-w-full">
                <thead>
                  <tr class="bg-gradient-to-r from-green-600 to-blue-600 text-white">
                    <th class="px-6 py-4 text-left font-semibold">Name</th>
                    <th class="px-6 py-4 text-left font-semibold">Email</th>
                    <th class="px-6 py-4 text-left font-semibold">Purpose</th>
                    <th class="px-6 py-4 text-left font-semibold">Message</th>
                    <th class="px-6 py-4 text-left font-semibold">Date</th>
                    <th class="px-6 py-4 text-left font-semibold">Status</th>
                    <th class="px-6 py-4 text-left font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="contactTable" class="divide-y divide-gray-200"></tbody>
              </table>
            </div>
            
            <div class="bg-white/80 rounded-2xl overflow-hidden shadow-xl">
              <h3 class="text-xl font-bold text-gray-700 p-6 border-b border-gray-200">Coffin Inquiries</h3>
              <table class="min-w-full">
                <thead>
                  <tr class="bg-gradient-to-r from-green-600 to-blue-600 text-white">
                    <th class="px-6 py-4 text-left font-semibold">Name</th>
                    <th class="px-6 py-4 text-left font-semibold">Email</th>
                    <th class="px-6 py-4 text-left font-semibold">Coffin</th>
                    <th class="px-6 py-4 text-left font-semibold">Message</th>
                    <th class="px-6 py-4 text-left font-semibold">Date</th>
                    <th class="px-6 py-4 text-left font-semibold">Status</th>
                    <th class="px-6 py-4 text-left font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody id="inquiryTable" class="divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Scheduling -->
        <section id="scheduleSection" class="bg-white/95 backdrop-blur-xl rounded-2xl p-8 shadow-2xl border border-blue-200/50 hover:shadow-3xl transition-all duration-300 hidden">
          <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl flex items-center justify-center shadow-xl">
              <i class="ph-clock text-3xl text-white"></i>
            </div>
            <div>
              <h2 class="text-3xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Scheduled Bookings & Meetings</h2>
              <p class="text-xl text-gray-600 font-medium">Manage appointments and scheduling</p>
            </div>
          </div>
          
          <div class="bg-white/80 rounded-2xl overflow-hidden shadow-xl">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                  <th class="px-6 py-4 text-left font-semibold">Name</th>
                  <th class="px-6 py-4 text-left font-semibold">Email</th>
                  <th class="px-6 py-4 text-left font-semibold">Service</th>
                  <th class="px-6 py-4 text-left font-semibold">Date</th>
                  <th class="px-6 py-4 text-left font-semibold">Message</th>
                  <th class="px-6 py-4 text-left font-semibold">Status</th>
                  <th class="px-6 py-4 text-left font-semibold">Submitted</th>
                  <th class="px-6 py-4 text-left font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="bookingTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </section>

        <!-- Customizable Service Options -->
        <section id="customSection" class="bg-white/95 backdrop-blur-xl rounded-2xl p-8 shadow-2xl border border-blue-200/50 hover:shadow-3xl transition-all duration-300 hidden">
          <div class="flex items-center gap-4 mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-orange-600 to-red-600 rounded-2xl flex items-center justify-center shadow-xl">
              <i class="ph-sliders-horizontal text-3xl text-white"></i>
            </div>
            <div>
              <h2 class="text-3xl font-black bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">Customizable Service Options</h2>
              <p class="text-xl text-gray-600 font-medium">Configure customizable service parameters</p>
            </div>
          </div>
          
          <form id="addOptionForm" class="bg-white/80 rounded-2xl p-8 mb-8 shadow-lg border border-blue-100">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Option Name</label>
                <input type="text" id="optionName" placeholder="e.g. Theme" required 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
              </div>
              <div class="space-y-2">
                <label class="block text-lg font-bold text-gray-700">Values</label>
                <input type="text" id="optionValues" placeholder="Comma separated values" required 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-all duration-300">
              </div>
              <button type="submit" class="bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 rounded-xl font-semibold hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3">
                <i class="ph-plus text-xl"></i>
                Add Option
              </button>
            </div>
          </form>
          
          <div class="bg-white/80 rounded-2xl overflow-hidden shadow-xl">
            <table class="min-w-full">
              <thead>
                <tr class="bg-gradient-to-r from-orange-600 to-red-600 text-white">
                  <th class="px-6 py-4 text-left font-semibold">Option</th>
                  <th class="px-6 py-4 text-left font-semibold">Values</th>
                  <th class="px-6 py-4 text-left font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody id="optionTable" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // Enhanced Sidebar navigation
    const navLinks = [
      { id: 'navServices', section: 'serviceSection' },
      { id: 'navSupport', section: 'supportSection' },
      { id: 'navSchedule', section: 'scheduleSection' },
      { id: 'navCustom', section: 'customSection' }
    ];
    
    navLinks.forEach((link, idx) => {
      const el = document.getElementById(link.id);
      el.onclick = () => {
        // Remove active state from all nav items
        navLinks.forEach(l => {
          document.getElementById(l.id).classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-green-600', 'text-white', 'shadow-lg');
          document.getElementById(l.id).classList.add('bg-white/80', 'hover:bg-gradient-to-r', 'hover:from-blue-600', 'hover:to-green-600', 'hover:text-white', 'shadow-md');
          document.getElementById(l.section).classList.add('hidden');
        });
        
        // Add active state to clicked nav item
        el.classList.remove('bg-white/80', 'hover:bg-gradient-to-r', 'hover:from-blue-600', 'hover:to-green-600', 'hover:text-white', 'shadow-md');
        el.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-green-600', 'text-white', 'shadow-lg');
        document.getElementById(link.section).classList.remove('hidden');
        
        // Load data based on section
        if (link.section === 'supportSection') loadSupport();
        if (link.section === 'scheduleSection') loadSchedule();
        if (link.section === 'customSection') loadOptions();
      };
    });

    // Enhanced Toast notification
    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      
      if (type === 'error') {
        toast.style.background = 'linear-gradient(to-r, #ef4444, #dc2626)';
      } else if (type === 'success') {
        toast.style.background = 'linear-gradient(to-r, #10b981, #059669)';
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    let currentAdmin = '';

    // Check admin session on page load
    async function checkAdminSession() {
      try {
        const res = await fetch('http://localhost:3000/admin/session', { credentials: 'include' });
        const result = await res.json();
        if (result.success) {
          // Session is valid, show dashboard
          currentAdmin = result.admin;
          document.getElementById('adminUser').textContent = result.admin;
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('adminDashboard').classList.remove('hidden');
          loadServices();
          updateStats();
        } else {
          // Session expired, show login form
          document.getElementById('adminDashboard').classList.add('hidden');
          document.getElementById('authSection').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Session check failed:', error);
        // Show login form on error
        document.getElementById('adminDashboard').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
      }
    }

    // Check session when page loads
    checkAdminSession();

    // Admin login
    const adminLoginForm = document.getElementById('adminLoginForm');
    adminLoginForm.onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      const res = await fetch('http://localhost:3000/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });
      
      const result = await res.json();
      if(result.success) {
        currentAdmin = username;
        document.getElementById('adminUser').textContent = username;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('adminDashboard').classList.remove('hidden');
        showToast('Login successful! Welcome to your dashboard.', 'success');
        loadServices();
        updateStats();
      } else {
        showToast(result.message || 'Login failed. Please check your credentials.', 'error');
      }
    };

    // Logout
    document.getElementById('logoutBtn').onclick = function() {
      location.reload();
    };

    // Update dashboard stats
    async function updateStats() {
      try {
        // Update total services
        const servicesRes = await fetch('http://localhost:3000/admin/services', { credentials: 'include' });
        if (servicesRes.ok) {
          const services = await servicesRes.json();
          document.getElementById('totalServices').textContent = services.length;
        }
        
        // Update pending inquiries
        const inquiriesRes = await fetch('http://localhost:3000/admin/inquiries', { credentials: 'include' });
        if (inquiriesRes.ok) {
          const inquiries = await inquiriesRes.json();
          const pending = inquiries.filter(inq => !inq.responded).length;
          document.getElementById('pendingInquiries').textContent = pending;
        }
      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }

    // Service management
    async function loadServices() {
      try {
        const res = await fetch('http://localhost:3000/admin/services', { credentials: 'include' });
        if (!res.ok) { 
          if (res.status === 401) {
            showToast('Session expired. Please log in again.', 'error');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            return;
          }
          showToast('Failed to load services. Please try again.', 'error');
          return;
        }
        
        const data = await res.json();
        const tbody = document.getElementById('serviceTable');
        tbody.innerHTML = '';
        
        data.forEach(service => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-all duration-300';
          tr.innerHTML = `
            <td class='px-6 py-4 font-bold text-gray-800'>${service.name}</td>
            <td class='px-6 py-4'>
              <span class='px-3 py-1 rounded-full text-xs font-semibold ${
                service.type === 'coffin'
                  ? 'bg-blue-100 text-blue-800'
                  : 'bg-green-100 text-green-800'
              }'>${service.type}</span>
            </td>
            <td class='px-6 py-4 font-bold text-green-600 text-lg'>â‚±${service.price}</td>
            <td class='px-6 py-4 text-gray-600'>${service.description || '-'}</td>
            <td class='px-6 py-4'>
              <div class='flex gap-3'>
                <button onclick='editService(${service.id})' class='px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors duration-200 flex items-center gap-2'>
                  <i class="ph-pencil"></i>Edit
                </button>
                <button onclick='deleteService(${service.id})' class='px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-200 flex items-center gap-2'>
                  <i class="ph-trash"></i>Delete
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        updateStats();
      } catch (error) {
        console.error('Error loading services:', error);
        showToast('Failed to load services. Please try again.', 'error');
      }
    }

    document.getElementById('addServiceForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('serviceName').value;
      const price = document.getElementById('servicePrice').value;
      const type = document.getElementById('serviceType').value;
      const description = document.getElementById('serviceDesc').value;
      
      const res = await fetch('http://localhost:3000/admin/services', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name, price, type, description })
      });
      
      const result = await res.json();
      if(result.success) {
        loadServices();
        this.reset();
        showToast('Service added successfully!', 'success');
      } else {
        showToast(result.message || 'Failed to add service.', 'error');
      }
    };

    window.editService = async function(id) {
      const newName = prompt('New name:');
      if (!newName) return;
      const newPrice = prompt('New price:');
      if (!newPrice) return;
      const newType = prompt('New type (coffin/service):');
      if (!newType) return;
      const newDesc = prompt('New description:');
      
      await fetch(`http://localhost:3000/admin/services/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name: newName, price: newPrice, type: newType, description: newDesc })
      });
      
      loadServices();
      showToast('Service updated successfully!', 'success');
    };

    window.deleteService = async function(id) {
      if (!confirm('Are you sure you want to delete this service?')) return;
      
      await fetch(`http://localhost:3000/admin/services/${id}`, { 
        method: 'DELETE', 
        credentials: 'include' 
      });
      
      loadServices();
      showToast('Service deleted successfully!', 'success');
    };

    // Customer Support
    async function loadSupport() {
      // Contact submissions
      let res = await fetch('http://localhost:3000/admin/contact', { credentials: 'include' });
      let data = await res.json();
      let tbody = document.getElementById('contactTable');
      tbody.innerHTML = '';
      
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-all duration-300';
        tr.innerHTML = `
          <td class='px-6 py-4 font-bold text-gray-800'>${row.name}</td>
          <td class='px-6 py-4 text-blue-600 font-medium'>${row.email}</td>
          <td class='px-6 py-4 text-gray-600'>${row.purpose || '-'}</td>
          <td class='px-6 py-4 text-gray-600 max-w-xs truncate'>${row.message}</td>
          <td class='px-6 py-4 text-sm text-gray-500'>${row.date ? new Date(row.date).toLocaleString() : '-'}</td>
          <td><span class='px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold'>New</span></td>
          <td><span class='text-gray-400'>-</span></td>
        `;
        tbody.appendChild(tr);
      });

      // Coffin inquiries
      res = await fetch('http://localhost:3000/admin/inquiries', { credentials: 'include' });
      data = await res.json();
      tbody = document.getElementById('inquiryTable');
      tbody.innerHTML = '';
      
      data.forEach((row, idx) => {
        const responded = row.responded ? 'Responded' : 'Pending';
        const statusClass = row.responded ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
        const actions = row.responded ? 
          '<span class="text-gray-400">-</span>' : 
          `<button onclick='respondInquiry(${idx})' class='px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors duration-200 flex items-center gap-2'><i class="ph-check"></i>Mark Responded</button>`;
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-all duration-300';
        tr.innerHTML = `
          <td class='px-6 py-4 font-bold text-gray-800'>${row.name}</td>
          <td class='px-6 py-4 text-blue-600 font-medium'>${row.email}</td>
          <td class='px-6 py-4 font-bold text-gray-800'>${row.coffin}</td>
          <td class='px-6 py-4 text-gray-600 max-w-xs truncate'>${row.message}</td>
          <td class='px-6 py-4 text-sm text-gray-500'>${row.date ? new Date(row.date).toLocaleString() : '-'}</td>
          <td><span class='px-3 py-1 rounded-full text-xs font-semibold ${statusClass}'>${responded}</span></td>
          <td>${actions}</td>
        `;
        tbody.appendChild(tr);
      });
      
      updateStats();
    }

    window.respondInquiry = async function(idx) {
      await fetch(`http://localhost:3000/admin/inquiries/${idx}/respond`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        credentials: 'include', 
        body: JSON.stringify({ response: 'Responded' }) 
      });
      
      loadSupport();
      showToast('Inquiry marked as responded!', 'success');
    };

    // Scheduling
    async function loadSchedule() {
      const res = await fetch('http://localhost:3000/admin/bookings', { credentials: 'include' });
      const data = await res.json();
      const tbody = document.getElementById('bookingTable');
      tbody.innerHTML = '';
      
      data.forEach((row, idx) => {
        const status = row.status || 'scheduled';
        let statusClass = 'bg-blue-100 text-blue-800';
        if (status === 'completed') statusClass = 'bg-green-100 text-green-800';
        else if (status === 'cancelled') statusClass = 'bg-red-100 text-red-800';
        
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-all duration-300';
        tr.innerHTML = `
          <td class='px-6 py-4 font-bold text-gray-800'>${row.name}</td>
          <td class='px-6 py-4 text-blue-600 font-medium'>${row.email}</td>
          <td class='px-6 py-4 font-bold text-gray-800'>${row.service}</td>
          <td class='px-6 py-4 text-gray-600'>${row.date}</td>
          <td class='px-6 py-4 text-gray-600 max-w-xs truncate'>${row.message}</td>
          <td><span class='px-3 py-1 rounded-full text-xs font-semibold ${statusClass}'>${status}</span></td>
          <td class='px-6 py-4 text-sm text-gray-500'>${row.dateSubmitted ? new Date(row.dateSubmitted).toLocaleString() : '-'}</td>
          <td>
            <button onclick='updateBookingStatus(${idx})' class='px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors duration-200 flex items-center gap-2'>
              <i class="ph-pencil"></i>Update Status
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.updateBookingStatus = async function(idx) {
      const status = prompt('Enter new status (scheduled/completed/cancelled):');
      if (!status) return;
      
      await fetch(`http://localhost:3000/admin/bookings/${idx}/status`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        credentials: 'include', 
        body: JSON.stringify({ status }) 
      });
      
      loadSchedule();
      showToast('Booking status updated successfully!', 'success');
    };

    // Customizable Options
    async function loadOptions() {
      const res = await fetch('http://localhost:3000/admin/options', { credentials: 'include' });
      const data = await res.json();
      const tbody = document.getElementById('optionTable');
      tbody.innerHTML = '';
      
      data.forEach(opt => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-all duration-300';
        tr.innerHTML = `
          <td class='px-6 py-4 font-bold text-gray-800'>${opt.name}</td>
          <td class='px-6 py-4 text-gray-600'>${opt.values.join(', ')}</td>
          <td>
            <button onclick='deleteOption(${opt.id})' class='px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors duration-200 flex items-center gap-2'>
              <i class="ph-trash"></i>Delete
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('addOptionForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('optionName').value;
      const values = document.getElementById('optionValues').value.split(',').map(v => v.trim()).filter(Boolean);
      
      const res = await fetch('http://localhost:3000/admin/options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name, values })
      });
      
      const result = await res.json();
      if(result.success) {
        loadOptions();
        this.reset();
        showToast('Option added successfully!', 'success');
      } else {
        showToast(result.message || 'Failed to add option.', 'error');
      }
    };

    window.deleteOption = async function(id) {
      if (!confirm('Are you sure you want to delete this option?')) return;
      
      await fetch(`http://localhost:3000/admin/options/${id}`, { 
        method: 'DELETE', 
        credentials: 'include' 
      });
      
      loadOptions();
      showToast('Option deleted successfully!', 'success');
    };
  </script>
</body>
</html>
